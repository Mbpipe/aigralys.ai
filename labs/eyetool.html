<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Medidor √ìptico Facial ‚Äî C√°mara + Gu√≠a CR80</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html,body{background:#eef2ff}
    .cam{
      width:100%;max-height:62vh;background:#000;border-radius:.75rem;
      object-fit:cover;transform:scaleX(-1);
    }
    .overlay{position:absolute;inset:0;pointer-events:none}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .hidden-el{display:none}
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const {useState,useEffect,useRef} = React;

function App(){
  const [dbg,setDbg]=useState({
    secure: window.isSecureContext,
    hasMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
    state:'idle', msg:''
  });

  const [image,setImage]=useState(null);
  const [error,setError]=useState('');
  const [cameraActive,setCameraActive]=useState(false);

  const videoRef=useRef(null);
  const streamRef=useRef(null);
  const overlayRef=useRef(null);

  // siempre enumeramos (ayuda a ver si Safari ve c√°maras)
  useEffect(()=>{
    if(!navigator.mediaDevices?.enumerateDevices) return;
    navigator.mediaDevices.enumerateDevices().then(list=>{
      const cams=list.filter(d=>d.kind==='videoinput');
      setDbg(d=>({...d,cams:cams.map(c=>({id:c.deviceId||'(id)',label:c.label||'(sin label)'}))}));
    }).catch(e=> setDbg(d=>({...d,msg:'enumerateDevices: '+e.name})));
  },[]);

  const nextFrame = () => new Promise(r=>requestAnimationFrame(()=>r()));

  const startCamera = async () => {
    setError('');
    setDbg(d=>({...d,state:'preparing',msg:''}));

    if(!window.isSecureContext){
      setError('La c√°mara requiere HTTPS / contexto seguro.');
      setDbg(d=>({...d,state:'error',msg:'No secure context'}));
      return;
    }
    if(!navigator.mediaDevices?.getUserMedia){
      setError('getUserMedia no est√° disponible.');
      setDbg(d=>({...d,state:'error',msg:'No mediaDevices'}));
      return;
    }

    // 1) Asegurar que el <video> exista en el DOM
    setCameraActive(true);           // <-- lo muestro/creo ya mismo
    await nextFrame();               // espera a que React pinte el <video>

    const v = videoRef.current;
    if(!v){
      setDbg(d=>({...d,state:'error',msg:'<video> null (DOM no listo)'}));
      return;
    }

    // flags iOS
    v.setAttribute('playsinline','true');
    v.setAttribute('autoplay','true');
    v.muted = true; v.playsInline = true;

    try{
      setDbg(d=>({...d,state:'requesting'}));
      const stream = await navigator.mediaDevices.getUserMedia({
        audio:false,
        video:{facingMode:{ideal:'user'},width:{ideal:1280},height:{ideal:720}}
      });
      streamRef.current = stream;
      v.srcObject = stream;

      // esperar metadata para tener dimensiones
      await new Promise(res=>{
        if(v.readyState>=1 && v.videoWidth) res();
        else v.addEventListener('loadedmetadata', res, {once:true});
      });

      // play
      try{ await v.play(); }
      catch(err){ setDbg(d=>({...d,msg:'video.play(): '+err.name})); }

      setDbg(d=>({...d,state:'ready',msg:d.msg||'ok'}));
    }catch(err){
      setError('No se pudo acceder a la c√°mara: '+err.name+(err.message?(' ‚Äî '+err.message):''));
      setDbg(d=>({...d,state:'error',msg:err.name}));
      // si fall√≥, dejamos el video visible pero sin stream; pod√©s cerrar
    }
  };

  const stopCamera = () => {
    try{
      const v=videoRef.current;
      v?.pause(); if(v) v.srcObject=null;
      if(streamRef.current){ streamRef.current.getTracks().forEach(t=>t.stop()); streamRef.current=null; }
    }finally{
      setCameraActive(false);
      setDbg(d=>({...d,state:'idle'}));
    }
  };

  const capturePhoto = () => {
    const v=videoRef.current;
    if(!v || !v.videoWidth){ setError('La c√°mara a√∫n no est√° lista.'); return; }
    const c=document.createElement('canvas'); c.width=v.videoWidth; c.height=v.videoHeight;
    c.getContext('2d').drawImage(v,0,0,c.width,c.height);
    setImage(c.toDataURL('image/jpeg',0.92));
  };

  const onUpload = (e) => {
    const f=e.target.files?.[0]; if(!f) return;
    const rd=new FileReader();
    rd.onload = ev => { setImage(ev.target.result); setError(''); };
    rd.readAsDataURL(f);
  };

  const openSystemCameraFallback = () => {
    document.getElementById('sysCamInput')?.click();
  };

  return (
    <div className="min-h-screen p-4">
      <div className="max-w-3xl mx-auto space-y-4">
        <div className="bg-white rounded-2xl shadow p-5 border-t-4 border-indigo-500">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold">Medidor √ìptico Facial</h1>
              <p className="text-slate-600">C√°mara embebida + Gu√≠a CR80</p>
            </div>
            <div className="text-xs bg-slate-100 px-2 py-1 rounded mono">
              secure:{String(dbg.secure)} media:{String(dbg.hasMedia)}
            </div>
          </div>
          <div className="mt-2 text-xs mono text-slate-600">
            estado: <b>{dbg.state}</b> {dbg.msg ? `‚Äî ${dbg.msg}` : ''}
            {Array.isArray(dbg.cams)&&dbg.cams.length>0 && (
              <span> ‚Ä¢ cams: {dbg.cams.map(c=>c.label||'cam').join(', ')}</span>
            )}
          </div>
        </div>

        <div className="bg-white rounded-2xl shadow p-5">
          <h2 className="text-xl font-semibold mb-3">Captura de Imagen</h2>

          <div className="grid grid-cols-2 gap-3">
            <label className="inline-flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl cursor-pointer">
              üñºÔ∏è <span>Subir Foto</span>
              <input type="file" className="hidden" accept="image/*" onChange={onUpload}/>
            </label>

            {!streamRef.current ? (
              <button
                type="button"
                onPointerDown={startCamera}
                className="inline-flex items-center justify-center gap-2 bg-violet-600 hover:bg-violet-700 text-white font-semibold py-3 rounded-xl">
                üì∑ C√°mara
              </button>
            ) : (
              <button type="button" onClick={stopCamera}
                className="inline-flex items-center justify-center gap-2 bg-rose-600 hover:bg-rose-700 text-white font-semibold py-3 rounded-xl">
                üõë Cerrar C√°mara
              </button>
            )}
          </div>

          {/* Fallback del sistema */}
          {!streamRef.current && (
            <div className="mt-3">
              <button type="button" onClick={openSystemCameraFallback}
                className="text-sm underline text-slate-600">Usar c√°mara del sistema (fallback)</button>
              <input id="sysCamInput" type="file" accept="image/*" capture="user" className="hidden" onChange={onUpload}/>
            </div>
          )}

          {/* El <video> SIEMPRE existe en el DOM.
              Solo lo oculto cuando no hay stream para evitar el error del ref nulo. */}
          <div className="mt-4 relative">
            <video ref={videoRef} className={`cam ${cameraActive?'':'hidden-el'}`} autoPlay playsInline muted></video>
            {cameraActive && <canvas ref={overlayRef} className="overlay"></canvas>}
            {streamRef.current && (
              <div className="mt-3 flex flex-wrap items-center gap-3">
                <button onClick={capturePhoto}
                        className="ml-auto inline-flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-xl">
                  üì∏ Capturar
                </button>
              </div>
            )}
          </div>
        </div>

        {image && (
          <div className="bg-white rounded-2xl shadow p-5">
            <h3 className="font-semibold mb-3">Imagen Actual</h3>
            <img src={image} alt="captura" className="w-full rounded-lg shadow"/>
          </div>
        )}

        {error && (
          <div className="bg-red-50 text-red-800 border border-red-200 rounded-xl p-4">
            <div className="font-semibold mb-1">Error</div>
            <div className="text-sm">{error}</div>
          </div>
        )}

        <div className="text-center text-xs text-slate-500 py-4">¬© 2025 ‚Äî C√°mara + Gu√≠a CR80</div>
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App/>);
</script>
</body>
</html>