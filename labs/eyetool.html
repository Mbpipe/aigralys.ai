<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Tester Cámara</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f5f7ff;margin:0;padding:16px}
  .card{max-width:720px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:16px}
  video{width:100%;height:auto;max-height:60vh;background:#000;border-radius:12px;object-fit:cover;transform:scaleX(-1)}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
  button{padding:12px 16px;border:0;border-radius:10px;font-weight:600;color:#fff;background:#5b21b6}
  button.sec{background:#dc2626}
  pre{background:#0f172a;color:#e2e8f0;padding:12px;border-radius:10px;overflow:auto;font-size:12px}
  .pill{background:#eef2ff;border-radius:999px;padding:6px 10px;font-size:12px;margin-left:8px}
</style>
</head>
<body>
<div class="card">
  <h2>Tester Cámara
    <span class="pill" id="secure"></span>
    <span class="pill" id="media"></span>
    <span class="pill" id="state"></span>
  </h2>
  <div class="row">
    <button id="open">📷 Abrir cámara</button>
    <button id="close" class="sec">🛑 Cerrar</button>
    <a id="system" href="#" style="margin-left:auto">Usar cámara del sistema (fallback)</a>
  </div>
  <video id="v" playsinline muted></video>
  <h3>Log</h3>
  <pre id="log"></pre>
</div>

<script>
const $ = id => document.getElementById(id);
const log = (...a)=>{ const l=$('log'); l.textContent += a.join(' ') + '\n'; l.scrollTop = l.scrollHeight; };
let stream = null;

$('secure').textContent = 'secure:'+ String(window.isSecureContext);
$('media').textContent  = 'media:'+ String(!!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia));
$('state').textContent  = 'state:idle';

$('system').href = 'camera://'; // iOS abrirá selector nativo desde input file si lo necesitas

async function openCam(){
  $('state').textContent='state:opening';
  const v = $('v');
  try{
    const constraints = { video:{ facingMode:{ideal:'user'}, width:{ideal:1280}, height:{ideal:720} }, audio:false };
    log('constraints=', JSON.stringify(constraints));
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    v.srcObject = stream;
    // iOS necesita play() tras asignar srcObject
    try{ await v.play(); }catch(e){ log('play() err:', e.message); setTimeout(()=>v.play().catch(()=>{}),150); }
    $('state').textContent='state:ready';
    log('✅ cámara lista');
  }catch(e){
    $('state').textContent='state:error';
    log('❌ getUserMedia error:', e && (e.name+': '+e.message));
  }
}

function closeCam(){
  const v=$('v');
  try{ v.pause(); }catch{}
  v.srcObject = null;
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  $('state').textContent='state:idle';
  log('⏹️ cámara cerrada');
}

$('open').onclick = openCam;
$('close').onclick = closeCam;

// Diagnóstico extra
(async()=>{
  try{
    if(navigator.permissions && navigator.permissions.query){
      const p = await navigator.permissions.query({name:'camera'});
      log('permiso cámara:', p.state);
      p.onchange = ()=> log('permiso cambió a:', p.state);
    }else{
      log('navigator.permissions no disponible');
    }
  }catch(e){ log('permiso error:', e.message); }
})();
</script>
</body>
</html>