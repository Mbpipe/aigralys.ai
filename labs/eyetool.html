<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Medidor √ìptico Facial ‚Äî Gu√≠a CR80</title>
<script src="https://cdn.tailwindcss.com"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<style>
  html,body{background:#eef2ff}
  #video{width:100%;height:auto;max-height:68vh;object-fit:cover;background:#000;border-radius:1rem;transform:scaleX(-1)}
  #overlay{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}
  .tag{font-variant-numeric:tabular-nums}
</style>
</head>
<body>
<div class="min-h-screen p-4">
  <div class="max-w-3xl mx-auto space-y-4">
    <div class="bg-white rounded-2xl shadow p-5 border-t-4 border-indigo-500">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold">Medidor √ìptico Facial</h1>
          <p class="text-slate-600">C√°mara + Gu√≠a CR80 + IPD</p>
        </div>
        <div id="env" class="text-xs bg-slate-100 px-3 py-1 rounded">‚Äî</div>
      </div>
      <div id="state" class="text-sm text-slate-500 mt-2">estado: idle</div>
    </div>

    <div class="bg-white rounded-2xl shadow p-5">
      <h2 class="text-xl font-semibold mb-3">Captura de Imagen</h2>
      <div class="grid grid-cols-2 gap-3">
        <label class="inline-flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl cursor-pointer">
          üñºÔ∏è <span>Subir Foto</span>
          <input id="file" type="file" accept="image/*" class="hidden">
        </label>
        <button id="btnCam" class="inline-flex items-center justify-center gap-2 bg-violet-600 hover:bg-violet-700 text-white font-semibold py-3 rounded-xl">üì∑ C√°mara</button>
      </div>

      <div id="camBox" class="mt-4 relative" style="display:none">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="overlay"></canvas>
        <canvas id="frame" class="hidden"></canvas>

        <div class="mt-3 grid gap-3 sm:grid-cols-2 items-center">
          <div class="flex flex-wrap items-center gap-3">
            <label class="inline-flex items-center gap-2">
              <input id="useGuide" type="checkbox" class="scale-110" checked>
              <span>Usar Gu√≠a CR80</span>
            </label>

            <label class="inline-flex items-center gap-2">
              <input id="autoCap" type="checkbox" class="scale-110" checked>
              <span>Auto-capturar (‚â•70%)</span>
            </label>

            <!-- NUEVO: orientaci√≥n -->
            <label class="inline-flex items-center gap-2">
              <input id="orient" type="checkbox" class="scale-110">
              <span>Vertical</span>
            </label>
          </div>

          <div class="flex items-center gap-3 sm:justify-end">
            <button id="btnCapture" class="flex-1 sm:flex-none inline-flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-3 rounded-xl">üì∏ Capturar</button>
            <button id="btnStop" class="inline-flex items-center justify-center gap-2 bg-rose-600 hover:bg-rose-700 text-white font-semibold px-4 py-3 rounded-xl">üõë Cerrar</button>
          </div>
        </div>

        <div id="guideControls" class="mt-3 flex flex-wrap items-center gap-3">
          <div class="flex-1 min-w-[220px]">
            <input id="guideSlider" type="range" min="140" max="420" value="260" class="w-full">
            <div class="text-xs text-slate-600">
              Ancho gu√≠a: <span id="gwTxt" class="tag">260</span> px ‚Ä¢ Alto: <span id="ghTxt" class="tag">164</span> px
              <span class="ml-2 text-slate-400">(CR80 85.60√ó53.98 mm)</span>
            </div>
          </div>
          <div class="px-3 py-2 rounded bg-slate-100 text-sm">
            Match: <b id="matchTxt" class="tag">0%</b> ‚Ä¢ OpenCV: <b id="ocvTxt" class="tag">0%</b>
          </div>
        </div>
      </div>
    </div>

    <div id="imgCard" class="bg-white rounded-2xl shadow p-5" style="display:none">
      <h3 class="font-semibold mb-3">Imagen Capturada</h3>
      <img id="img" class="w-full rounded-lg shadow" alt="captura">
      <div class="mt-3">
        <button id="btnProcess" class="inline-flex items-center justify-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-3 rounded-xl">üßÆ Procesar</button>
        <span id="procStep" class="text-sm text-slate-600 ml-3"></span>
      </div>
    </div>

    <div id="resCard" class="bg-white rounded-2xl shadow p-5 space-y-3" style="display:none">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">Resultado</h3>
        <span id="method" class="text-xs px-2 py-1 rounded bg-slate-100">‚Äî</span>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div class="p-3 rounded bg-indigo-50">
          <div class="text-xs text-slate-600">IPD</div>
          <div id="ipd" class="text-2xl font-bold">‚Äî</div>
        </div>
        <div class="p-3 rounded bg-violet-50">
          <div class="text-xs text-slate-600">Escala (px/mm)</div>
          <div id="pxmm" class="text-xl font-semibold tag">‚Äî</div>
          <div id="scaleFrom" class="text-xs text-slate-500">‚Äî</div>
        </div>
      </div>
      <div class="mt-2">
        <h4 class="font-semibold mb-2">Imagen Anotada</h4>
        <img id="annot" class="w-full rounded-lg shadow" alt="anotada">
        <a id="annotDl" class="inline-block mt-3 px-3 py-2 rounded bg-blue-600 text-white">Descargar PNG</a>
      </div>
    </div>

    <div class="text-center text-xs text-slate-500 py-4">¬© 2025 ‚Äî C√°mara + Gu√≠a CR80</div>
  </div>
</div>

<script>
(() => {
  const CR80_W=85.60, CR80_H=53.98, AR = CR80_W/CR80_H;

  // UI
  const env=document.getElementById('env'), state=document.getElementById('state');
  const btnCam=document.getElementById('btnCam'), btnStop=document.getElementById('btnStop');
  const btnCapture=document.getElementById('btnCapture');
  const useGuide=document.getElementById('useGuide'), autoCap=document.getElementById('autoCap');
  const orient=document.getElementById('orient'); // false: horizontal, true: vertical
  const slider=document.getElementById('guideSlider'), gwTxt=document.getElementById('gwTxt'), ghTxt=document.getElementById('ghTxt');
  const matchTxt=document.getElementById('matchTxt'), ocvTxt=document.getElementById('ocvTxt');
  const camBox=document.getElementById('camBox'), video=document.getElementById('video'), overlay=document.getElementById('overlay'), frame=document.getElementById('frame');
  const file=document.getElementById('file'), img=document.getElementById('img'), imgCard=document.getElementById('imgCard');
  const btnProcess=document.getElementById('btnProcess'), procStep=document.getElementById('procStep');
  const resCard=document.getElementById('resCard'), method=document.getElementById('method'), ipd=document.getElementById('ipd'), pxmm=document.getElementById('pxmm'), scaleFrom=document.getElementById('scaleFrom');
  const annot=document.getElementById('annot'), annotDl=document.getElementById('annotDl');

  const secure = location.protocol==='https:' || location.hostname==='localhost';
  const media = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
  env.textContent = `secure:${secure} ‚Ä¢ media:${media}`;

  let stream=null, raf=0, ocvScore=0, edgeScore=0, stable=0, cooldown=false;
  let faceMesh=null; // opcional

  // MediaPipe FaceMesh
  (function loadFM(){
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js';
    s.async=true;
    s.onload=()=>{
      faceMesh = new window.FaceMesh({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
      faceMesh.setOptions({maxNumFaces:1,refineLandmarks:true,minDetectionConfidence:.5,minTrackingConfidence:.5});
    };
    document.body.appendChild(s);
  })();

  // C√°mara
  async function startCam(){
    if(!media){ alert('Tu navegador no permite c√°mara.'); return; }
    state.textContent='estado: solicitando c√°mara‚Ä¶';
    try{
      video.setAttribute('playsinline',''); video.muted=true; video.playsInline=true;
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'user'},width:{ideal:1280},height:{ideal:720}}, audio:false});
      video.srcObject=stream; await video.play().catch(()=>{});
      camBox.style.display=''; state.textContent='estado: ready';
      startLoop();
    }catch(e){ state.textContent='estado: error ‚Äî '+e.message; }
  }
  function stopCam(){
    cancelAnimationFrame(raf); raf=0;
    if(video){ video.pause(); video.srcObject=null; }
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    camBox.style.display='none'; state.textContent='estado: idle';
  }

  // OpenCV ROI score (0..1) ‚Äî robusto y r√°pido
  function ocvScoreROI(imgData,w,h){
    const cv=window.cv; if(!cv||!cv.Mat) return null;
    try{
      const src=cv.matFromImageData(imgData), gray=new cv.Mat(), blur=new cv.Mat(), edges=new cv.Mat();
      cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY); cv.GaussianBlur(gray,blur,new cv.Size(5,5),0);
      let sum=0; const d=blur.data; for(let i=0;i<d.length;i++) sum+=d[i];
      const mean=sum/d.length; cv.Canny(blur,edges,Math.max(0,.66*mean),Math.min(255,1.33*mean));
      const contours=new cv.MatVector(), hier=new cv.Mat();
      cv.findContours(edges,contours,hier,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);
      let best=0;
      for(let i=0;i<contours.size();i++){
        const cnt=contours.get(i); const area=cv.contourArea(cnt);
        if(area<(w*h)*0.06){ cnt.delete(); continue; }
        const peri=cv.arcLength(cnt,true), ap=new cv.Mat(); cv.approxPolyDP(cnt,ap,0.02*peri,true);
        if(ap.rows===4){
          const rect=cv.minAreaRect(cnt); const W=rect.size.width,H=rect.size.height;
          const long=Math.max(W,H), short=Math.min(W,H), ar=long/short, ideal=AR;
          const aScore=Math.max(0,1-Math.min(Math.abs(ar-ideal)/0.35,1));
          const cScore=Math.max(0,Math.min(1,(area/(w*h))*2.0));
          best=Math.max(best,aScore*.7+cScore*.3);
        }
        ap.delete(); cnt.delete();
      }
      gray.delete(); blur.delete(); edges.delete(); contours.delete(); hier.delete(); src.delete();
      return best;
    }catch(e){ return null; }
  }

  function startLoop(){
    const octx=overlay.getContext('2d',{willReadFrequently:true});
    const fctx=frame.getContext('2d',{willReadFrequently:true});

    const loop=()=>{
      if(!video.videoWidth){ raf=requestAnimationFrame(loop); return; }

      // Ajustar canvas overlay al tama√±o CSS REAL del <video>
      const rect = video.getBoundingClientRect();
      overlay.width = Math.round(rect.width);
      overlay.height= Math.round(rect.height);

      // Dimensiones de gu√≠a con AR correcto seg√∫n orientaci√≥n
      const gwCSS = parseInt(slider.value,10);
      const ghCSS = orient.checked ? Math.round(gwCSS*AR) : Math.round(gwCSS/AR);
      gwTxt.textContent = gwCSS; ghTxt.textContent = ghCSS;

      const gx = Math.round((overlay.width-gwCSS)/2);
      const gy = Math.round((overlay.height-ghCSS)/2);

      // Fondo gris con ventana transparente
      octx.clearRect(0,0,overlay.width,overlay.height);
      octx.fillStyle='rgba(0,0,0,.35)'; octx.fillRect(0,0,overlay.width,overlay.height);
      octx.clearRect(gx,gy,gwCSS,ghCSS);

      // Limites reales del frame (tener en cuenta letterboxing)
      const scale = Math.min(rect.width / video.videoWidth, rect.height / video.videoHeight);
      const realW = video.videoWidth*scale, realH = video.videoHeight*scale;
      const offX = (rect.width-realW)/2, offY=(rect.height-realH)/2;

      // ROI en coords reales
      const rx = Math.max(0, Math.round((gx-offX)/scale));
      const ry = Math.max(0, Math.round((gy-offY)/scale));
      const rw = Math.max(1, Math.round(gwCSS/scale));
      const rh = Math.max(1, Math.round(ghCSS/scale));

      // Pintar marco (morado/verde)
      const frameColor = '#a78bfa';
      octx.strokeStyle = frameColor; octx.lineWidth=4; octx.strokeRect(gx,gy,gwCSS,ghCSS);

      // Preparar frame real
      frame.width=video.videoWidth; frame.height=video.videoHeight;
      fctx.drawImage(video,0,0,frame.width,frame.height);

      // M√©trica simple de bordes
      let imgData=null; try{ imgData=fctx.getImageData(rx,ry,rw,rh); }catch(e){}
      edgeScore = 0;
      if(imgData){
        const data=imgData.data, thick=3; let edge=0, total=0;
        const isE=(r,g,b)=>{ const lum=.299*r+.587*g+.114*b; return (lum<80||lum>200); };
        for(let y=0;y<rh;y++){
          for(let x=0;x<rw;x++){
            const b=(y<thick)||(y>=rh-thick)||(x<thick)||(x>=rw-thick); if(!b) continue;
            const i=(y*rw+x)*4; if(isE(data[i],data[i+1],data[i+2])) edge++; total++;
          }
        }
        edgeScore = total? edge/total : 0;
      }

      // OpenCV 1/3 frames
      if(loop._f===undefined) loop._f=0;
      if(imgData && loop._f%3===0){
        const s = ocvScoreROI(imgData,rw,rh);
        if(s!=null) ocvScore = s;
      }
      loop._f++;

      const combined = Math.max(edgeScore, ocvScore||0);
      matchTxt.textContent = Math.round(edgeScore*100)+'%';
      ocvTxt.textContent   = Math.round((ocvScore||0)*100)+'%';

      // Cabecera
      octx.strokeStyle = combined>=0.7 ? '#22c55e' : '#a78bfa';
      octx.lineWidth=4; octx.strokeRect(gx,gy,gwCSS,ghCSS);
      octx.fillStyle='#fff'; octx.font='bold 14px system-ui,-apple-system';
      octx.fillText(`Gu√≠a CR80 ‚Äî Match ${Math.round(combined*100)}%`, gx+10, Math.max(18, gy-8));

      // Auto-capture estable
      if(useGuide.checked && autoCap.checked){
        if(combined>=0.7) stable++; else stable=0;
        if(stable>=10 && !cooldown){ cooldown=true; capture(); setTimeout(()=>cooldown=false,2000); stable=0; }
      }else stable=0;

      raf=requestAnimationFrame(loop);
    };
    cancelAnimationFrame(raf); raf=requestAnimationFrame(loop);
  }

  function capture(){
    if(!video.videoWidth){ alert('La c√°mara a√∫n no est√° lista.'); return; }
    const c=document.createElement('canvas'); c.width=video.videoWidth; c.height=video.videoHeight;
    c.getContext('2d').drawImage(video,0,0,c.width,c.height);
    img.src=c.toDataURL('image/jpeg',0.92);
    imgCard.style.display=''; resCard.style.display='none'; procStep.textContent='Imagen capturada';
    window.scrollTo({top:imgCard.offsetTop-12,behavior:'smooth'});
  }

  // Procesado (escala SIEMPRE desde gu√≠a dibujada en pantalla)
  function process(){
    if(!img.src) return;
    (async ()=>{
      procStep.textContent='Detectando‚Ä¶';
      const m=await loadImg(img.src);

      const gwCSS=parseInt(slider.value,10);
      const pxPerMm = gwCSS/CR80_W; // el ancho de la gu√≠a SIEMPRE representa 85.60 mm
      pxmm.textContent = pxPerMm.toFixed(3);
      scaleFrom.textContent = 'De gu√≠a CR80 en overlay';

      const LM=await getLandmarks(m);
      const dx=LM.r.x-LM.l.x, dy=LM.r.y-LM.l.y;
      const ipdVal = Math.round((Math.hypot(dx,dy)/pxPerMm)*10)/10;

      // Anotar
      const A=document.createElement('canvas'); A.width=m.width; A.height=m.height;
      const a=A.getContext('2d'); a.drawImage(m,0,0);
      a.fillStyle='#f00'; a.beginPath(); a.arc(LM.l.x,LM.l.y,10,0,Math.PI*2); a.fill();
      a.beginPath(); a.arc(LM.r.x,LM.r.y,10,0,Math.PI*2); a.fill();
      a.strokeStyle='#f00'; a.lineWidth=3; a.beginPath(); a.moveTo(LM.l.x,LM.l.y); a.lineTo(LM.r.x,LM.r.y); a.stroke();
      a.font='bold 24px system-ui,-apple-system'; a.fillStyle='#fff'; a.strokeStyle='#000'; a.lineWidth=5;
      const mx=(LM.l.x+LM.r.x)/2, my=(LM.l.y+LM.r.y)/2-20;
      a.strokeText(`IPD: ${ipdVal} mm`, mx-70, my); a.fillText(`IPD: ${ipdVal} mm`, mx-70, my);

      const url=A.toDataURL('image/png'); annot.src=url; annotDl.href=url; annotDl.download=`annotated-${Date.now()}.png`;
      ipd.textContent = ipdVal+' mm'; method.textContent = LM.method;
      resCard.style.display=''; procStep.textContent='Hecho';
      window.scrollTo({top:resCard.offsetTop-12,behavior:'smooth'});
    })();
  }

  function loadImg(u){return new Promise((r,j)=>{const i=new Image();i.src=u;i.onload=()=>r(i);i.onerror=j;});}
  function getLandmarks(img){
    return new Promise((resolve)=>{
      if(window.FaceMesh && faceMesh){
        const c=document.createElement('canvas'); c.width=img.width; c.height=img.height; c.getContext('2d').drawImage(img,0,0);
        faceMesh.onResults(r=>{
          if(r.multiFaceLandmarks && r.multiFaceLandmarks[0]){
            const L=r.multiFaceLandmarks[0];
            const iris=a=>({x:a.reduce((s,l)=>s+l.x*img.width,0)/a.length,y:a.reduce((s,l)=>s+l.y*img.height,0)/a.length});
            resolve({l:iris(L.slice(473,477)), r:iris(L.slice(468,472)), method:'MediaPipe'});
          }else{
            const cx=img.width/2, cy=img.height*0.45, d=img.width*0.15;
            resolve({l:{x:cx-d/2,y:cy}, r:{x:cx+d/2,y:cy}, method:'Estimaci√≥n'});
          }
        });
        faceMesh.send({image:c});
      }else{
        const cx=img.width/2, cy=img.height*0.45, d=img.width*0.15;
        resolve({l:{x:cx-d/2,y:cy}, r:{x:cx+d/2,y:cy}, method:'Estimaci√≥n'});
      }
    });
  }

  // eventos
  btnCam.onclick=startCam; btnStop.onclick=stopCam; btnCapture.onclick=capture; btnProcess.onclick=process;
  file.onchange=(e)=>{const f=e.target.files?.[0]; if(!f) return; const rd=new FileReader(); rd.onload=v=>{img.src=v.target.result; imgCard.style.display=''; resCard.style.display='none'; procStep.textContent='Imagen cargada';}; rd.readAsDataURL(f);};
  slider.oninput=()=>{const w=parseInt(slider.value,10); const h = orient.checked ? Math.round(w*AR) : Math.round(w/AR); gwTxt.textContent=w; ghTxt.textContent=h;};
  orient.onchange=()=>slider.oninput();

})();
</script>
</body>
</html>